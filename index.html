<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <link rel="stylesheet" href="assets/style.css?t=a44c9e9d">
    <link rel="stylesheet" href="assets/docpress.css?t=52d3f23f">
    <link rel="stylesheet" href="assets/custom.css?t=39201656">
    <script src="assets/search.js?t=cd392b82"></script>
    <script src="assets/script.js?t=820b7ffa"></script>
    <title>Kesko HTTP Service Design</title>
    <meta name="viewport" content="width=device-width">
  </head>
  <body class="-menu-visible">
    <div class="doc-layout">
      <div class="toggle menu-toggle js-menu-toggle"></div>
      <div class="body page-index">
        <div class="header-nav">
          <div class="right"><a href="https://github.com/kesko-dev/http-service-design" data-title="kesko-dev/http-service-design" class="iconlink">
              <!-- span.title Open in GitHub--><span class="icon -github"></span></a>
          </div>
        </div>
        <div class="markdown-body"><h1 id="kesko-http-service-design">Kesko HTTP Service Design</h1>
<p><a href="https://travis-ci.org/kesko-dev/http-service-design"><img src="https://travis-ci.org/kesko-dev/http-service-design.svg?branch=master" alt="Build Status"></a></p>
<div class="alert alert-danger" role="alert">
<p>The guide is work in progress. Some advice are even contradictory and not stabilized yet.</p>
</div>
<p><em>This documentation was forked
from <a href="https://github.com/interagent/http-api-design">https://github.com/interagent/http-api-design</a> and transformed to use
<a href="https://github.com/docpress/docpress">docpress</a> instead of <a href="https://www.gitbook.com/">GitBook</a>
format. The original documentation is extracted from work on the
<a href="https://devcenter.heroku.com/articles/platform-api-reference">Heroku Platform API</a>.</em></p>
<h3 id="goal-of-the-document"><a class="header-anchor" href="#goal-of-the-document" aria-hidden="true">&#xB6;</a> Goal of the document</h3>
<blockquote>
<p>Support developers to create consistent and good APIs.</p>
</blockquote>
<p>There are tens or hundreds of individual APIs and this guide tries to ensure that
API users can trust them to follow the same conventions. This speeds up
app development, communication, API design process, and more.</p>
<p>Our goals here are consistency and focusing on business logic while
avoiding design bikeshedding. We&#x2019;re looking for <em>a good, consistent,
well-documented way</em> to design APIs, not necessarily <em>the only/ideal
way</em>.</p>
<h2 id="services-must"><a class="header-anchor" href="#services-must" aria-hidden="true">&#xB6;</a> Services must</h2>
<h3 id="provide-certain-mandatory-artifactsactions"><a class="header-anchor" href="#provide-certain-mandatory-artifactsactions" aria-hidden="true">&#xB6;</a> Provide certain mandatory artifacts/actions</h3>
<p>When a new service is created, these artifacts/actions are required:</p>
<ol>
<li>
<p>API documentation as <a href="http://swagger.io/">Swagger 2.0 YAML</a></p>
<p>The latest Swagger YAML/JSON definition should be always uploaded to IBM API Connect.</p>
<p>For services based on the common Hapi/Hapi-swagger template, the Swagger definition will be
available to download from the <code>/swagger.json</code> path on the running service. This definition can be used
to add the API under an existing product in IBM API Connect.</p>
<p>To push a new version of your API to IBM API Connect you can use a command-line based tool available
<a href="https://github.com/kesko-dev/kesko-node-common/tree/master/apic-tools">here</a>.</p>
<p>Currently, the command-line tool cannot add new APIs in a catalog (only in Drafts). The API can be first
published to a catalog using the IBM API Connect web interface, and then later updated using the command-line tool.</p>
</li>
<li>
<p>Public API is exposed via IBM API Connect</p>
</li>
<li>
<p>&#x201C;How to get the service running&#x201D; -documentation</p>
<p>Your service repository should provide or link to this type of documentation in
<a href="http://README.md">README.md</a> file.</p>
<p>Preferably the service would use Docker or Vagrant to run local environment.
This makes it easier to kickstart the development for new developers or
maintainers joining the project.</p>
</li>
</ol>
<p>See also <a href="#service-building-tips">Service building tips</a> for additional information
how to build services.</p>
<h3 id="support-kesko-openid-authentication"><a class="header-anchor" href="#support-kesko-openid-authentication" aria-hidden="true">&#xB6;</a> Support Kesko OpenID authentication</h3>
<p><a href="http://openid.net/connect/">OpenID Connect</a> is used for user authentication.
It provides a way for applications(Mobile, web or any clients) to perform
operations on behalf of the user without ever needing to know the details
of that identity (e.g. username and password).</p>
<p><img src="assets/img/kesko-authentication.png" alt="Authentication diagram"></p>
<ol>
<li>
<p>Client executes <a href="https://www.ibm.com/support/knowledgecenter/SSWHYP_4.0.0/com.ibm.apimgmt.apionprem.doc/tutorial_apionprem_security_OAuth.html">OAuth2 Authorization code flow</a> to receive <code>access_token</code>.</p>
<p>The <code>access_token</code> is an encoded JWT token.</p>
</li>
<li>
<p>Client requests <code>/api/x</code> via API Gateway with correct Authorization: Bearer &lt;access_token&gt; header.</p>
</li>
<li>
<p>API Gateway includes e.g. <code>x-token</code> header in the request and passes it to Service X.</p>
<p>The <code>x-token</code> is a shared secret between Service X and API Gateway.</p>
<p><strong>Note:</strong> <code>x-token</code> is just one of the ways to authenticate requests between
API Gateway and backing services. It is important that there is <strong>some</strong>
mechanism to authenticate the requests, but it doesn&#x2019;t need to be
exactly <code>x-token</code> header mechanism.</p>
</li>
<li>
<p>Service X verifies <code>x-token</code> and Authorization header.</p>
<p>Authorization header is a JWT token which has been encoded with a
private key <em>(only OpenID knows this)</em>.
Service can verify the signature by using a public key which
OpenID service publicly provides.</p>
</li>
<li>
<p>Service X can now trust that the request came via API Gateway and JWT payload was created by OpenID service.</p>
<p>JWT Payload contains information about the end user who made the request.
Service can use this e.g. information to implement fine grained authorization.</p>
</li>
</ol>
<h3 id="require-versioning-headers"><a class="header-anchor" href="#require-versioning-headers" aria-hidden="true">&#xB6;</a> Require versioning headers</h3>
<p>Versioning and the transition between versions can be one of the more
challenging aspects of designing and operating an API. As such, it is best to
start with some mechanisms in place to mitigate this from the start.</p>
<p>To prevent surprise, breaking changes to users, it is best to require a version
be specified with all requests. Default versions should be avoided as they are
very difficult, at best, to change in the future.</p>
<p>It is best to provide version specification in the headers, with other
metadata, using the <code>Accept</code> header with a custom content type, e.g.:</p>
<pre><code>Accept: application/json; version=3
</code></pre>
<p>See <a href="http://zalando.github.io/restful-api-guidelines/compatibility/Compatibility.html#must-do-not-use-uri-versioning">Zalando versioning guidelines</a>
for more.</p>
<h4 id="(todo)-when-and-how-to-bump-api-version"><a class="header-anchor" href="#todo-when-and-how-to-bump-api-version" aria-hidden="true">&#xB6;</a> (TODO) When and how to bump API version</h4>
<p>Follow <a href="http://zalando.github.io/restful-api-guidelines/compatibility/Compatibility.html#must-do-not-use-uri-versioning">Zalando versioning guidelines</a>.</p>
<h3 id="require-https"><a class="header-anchor" href="#require-https" aria-hidden="true">&#xB6;</a> Require HTTPS</h3>
<p>Require secure connections with TLS to access the API, without exception.
It&#x2019;s not worth trying to figure out or explain when it is OK to use TLS
and when it&#x2019;s not. Just require TLS for everything.</p>
<p>Ideally, simply reject any non-TLS requests by not responding to requests for
http or port 80 to avoid any insecure data exchange. In environments where this
is not possible, respond with <code>403 Forbidden</code>.</p>
<p>Redirects are discouraged since they allow sloppy/bad client behaviour without
providing any clear gain.  Clients that rely on redirects double up on
server traffic and render TLS useless since sensitive data will already
have been exposed during the first call.</p>
<h3 id="use-swagger-2.0-to-describe-apis"><a class="header-anchor" href="#use-swagger-20-to-describe-apis" aria-hidden="true">&#xB6;</a> Use Swagger 2.0 to describe APIs</h3>
<p>Your APIs should be described as Swagger 2.0 YAML format. This shouldn&#x2019;t be
a manually maintained. It should be generated from the service&#x2019;s
HTTP endpoint code.</p>
<div class="alert alert-danger" role="alert">
<p>Don&#x2019;t maintain API endpoints, parameters and their descriptions in multiple places.
They will go out of sync.</p>
</div>
<h3 id="provide-human-readable-documentation-via-api-connect"><a class="header-anchor" href="#provide-human-readable-documentation-via-api-connect" aria-hidden="true">&#xB6;</a> Provide human-readable documentation via API Connect</h3>
<p>In addition to endpoint details, provide an API overview with
information about:</p>
<ul>
<li>
<p>API stability and versioning, including how to select the desired API
version.</p>
</li>
<li>
<p>Common request and response headers.</p>
</li>
<li>
<p>Error serialization format.</p>
</li>
<li>
<p>Examples of using the API with clients in different languages.</p>
<p>API Connect does this when correct Swagger examples are specified.</p>
</li>
</ul>
<h3 id="accept-serialized-json-in-request-bodies"><a class="header-anchor" href="#accept-serialized-json-in-request-bodies" aria-hidden="true">&#xB6;</a> Accept serialized JSON in request bodies</h3>
<p>Accept serialized JSON on <code>PUT</code>/<code>PATCH</code>/<code>POST</code> request bodies, either
instead of or in addition to form-encoded data. This creates symmetry
with JSON-serialized response bodies, e.g.:</p>
<pre><code class="lang-bash">$ curl -X POST https://service.com/apps \
    -H <span class="pl-s">&quot;Content-Type: application/json&quot;</span> \
    <span class="hljs-_">-d</span> <span class="pl-s">&apos;{&quot;name&quot;: &quot;demoapp&quot;}&apos;</span>

{
  <span class="pl-s">&quot;id&quot;</span>: <span class="pl-s">&quot;01234567-89ab-cdef-0123-456789abcdef&quot;</span>,
  <span class="pl-s">&quot;name&quot;</span>: <span class="pl-s">&quot;demoapp&quot;</span>,
  <span class="pl-s">&quot;owner&quot;</span>: {
    <span class="pl-s">&quot;email&quot;</span>: <span class="pl-s">&quot;username@example.com&quot;</span>,
    <span class="pl-s">&quot;id&quot;</span>: <span class="pl-s">&quot;01234567-89ab-cdef-0123-456789abcdef&quot;</span>
  },
  ...
}
</code></pre>
<h3 id="use-consistent-http-methods"><a class="header-anchor" href="#use-consistent-http-methods" aria-hidden="true">&#xB6;</a> Use consistent HTTP methods</h3>
<table>
<thead>
<tr>
<th>Method</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>HEAD</td>
<td>Can be issued against any resource to get just the HTTP header info.</td>
</tr>
<tr>
<td>GET</td>
<td>Get one or multiple resources.</td>
</tr>
<tr>
<td>POST</td>
<td>Create a new resource. Id of the resource is unknown before request.</td>
</tr>
<tr>
<td>PUT</td>
<td>Fully replace an existing resource. Id of the resource is known before request. <strong>Note: You must send the full object on each PUT request.</strong></td>
</tr>
<tr>
<td>PATCH</td>
<td>Add or modify attributes for an existing resource.</td>
</tr>
<tr>
<td>DELETE</td>
<td>Delete an existing resources.</td>
</tr>
</tbody>
</table>
<p>Good examples:</p>
<ul>
<li><strong><code>GET /api/products</code></strong> Get paginated array of products.</li>
<li><strong><code>GET /api/products/:id</code></strong> Get product by id.</li>
<li><strong><code>DELETE /api/products/:id</code></strong> Delete product by id.</li>
<li><strong><code>POST /api/products</code></strong> Create a new product.</li>
<li><strong><code>PUT /api/products/:id</code></strong> Replace a products.</li>
<li><strong><code>PATCH /api/products/:id</code></strong> Add or modify attributes for a products.</li>
<li><strong><code>PUT /api/servers/:id/actions/hibernate</code></strong> Special &#x201C;hibernate&#x201D; action for a virtual machine.</li>
</ul>
<h3 id="special-action-endpoints"><a class="header-anchor" href="#special-action-endpoints" aria-hidden="true">&#xB6;</a> Special action endpoints</h3>
<p>Prefer endpoint layouts that don&#x2019;t need any special actions for
individual resources. In cases where special actions are needed, place
them under a standard <code>actions</code> prefix, to clearly delineate them:</p>
<pre><code>/resources/:resource/actions/:action
</code></pre>
<p>e.g.</p>
<ul>
<li><code>/products/actions/search</code></li>
<li><code>/machines/1/actions/shutdown</code></li>
</ul>
<p>Use <code>POST</code> or <code>PUT</code> method for actions.</p>
<h3 id="follow-naming-conventions"><a class="header-anchor" href="#follow-naming-conventions" aria-hidden="true">&#xB6;</a> Follow naming conventions</h3>
<p>When each API follows the same rules, using the Kesko API ecosystem becomes
much easier as you can trust to certain conventions.</p>
<p>If some conventions are not documented, always follow existing conventions.
When introducing a new convention, there should be a plan how it will
be taken into use in all services.</p>
<div class="alert alert-danger" role="alert">
<p>Changing API conventions across
multiple services takes time, so choose wisely.</p>
</div>
<h4 id="use-json-naming-conventions"><a class="header-anchor" href="#use-json-naming-conventions" aria-hidden="true">&#xB6;</a> Use JSON naming conventions</h4>
<p>Use camelcased attribute names, plural array keys and correct JSON types for data. You may use strings
for money to make sure the API user acknowledges that using float values is dangerous.</p>
<p>Example of good JSON naming conventions:</p>
<pre><code class="lang-json">{
  &quot;<span class="hljs-attr">id</span>&quot;: <span class="pl-s">&quot;123e4567-e89b-12d3-a456-426655440000&quot;</span>,
  &quot;<span class="hljs-attr">name</span>&quot;: <span class="pl-s">&quot;Test Name&quot;</span>,
  &quot;<span class="hljs-attr">plussaCards</span>&quot;: [
    {
      &quot;<span class="hljs-attr">number</span>&quot;: <span class="pl-s">&quot;0123123191999&quot;</span>,
      &quot;<span class="hljs-attr">owner</span>&quot;: {
        &quot;<span class="hljs-attr">_link</span>&quot;: <span class="pl-s">&quot;https://keskoapi.com/api/users/123e4567-e89b-12d3-a456-426655440003&quot;</span>,
        &quot;<span class="hljs-attr">id</span>&quot;: <span class="pl-s">&quot;123e4567-e89b-12d3-a456-426655440003&quot;</span>
      }
    },
    {
      &quot;<span class="hljs-attr">number</span>&quot;: <span class="pl-s">&quot;0123123191998&quot;</span>,
      &quot;<span class="hljs-attr">owner</span>&quot;: {
        &quot;<span class="hljs-attr">_link</span>&quot;: <span class="pl-s">&quot;https://keskoapi.com/api/users/123e4567-e89b-12d3-a456-426655440003&quot;</span>,
        &quot;<span class="hljs-attr">id</span>&quot;: <span class="pl-s">&quot;123e4567-e89b-12d3-a456-426655440003&quot;</span>
      }
    }
  ],
  &quot;<span class="hljs-attr">birthYear</span>&quot;: <span class="hljs-number">1991</span>
}
</code></pre>
<h4 id="downcase-and-dash-separated-paths"><a class="header-anchor" href="#downcase-and-dash-separated-paths" aria-hidden="true">&#xB6;</a> Downcase and dash-separated paths</h4>
<p>Use downcased and dash-separated path names, for alignment with
hostnames, e.g:</p>
<pre><code>service-api.com/users
service-api.com/app-setups
</code></pre>
<h4 id="camelcase-query-parameters"><a class="header-anchor" href="#camelcase-query-parameters" aria-hidden="true">&#xB6;</a> Camelcase query parameters</h4>
<p>Use camelcase in query parameter names:</p>
<pre><code>?isAdmin=true
?hasComment=false&amp;minRating=1.2
</code></pre>
<h4 id="use-consistent-query-parameter-types"><a class="header-anchor" href="#use-consistent-query-parameter-types" aria-hidden="true">&#xB6;</a> Use consistent query parameter types</h4>
<table>
<thead>
<tr>
<th>Type</th>
<th>Good examples</th>
<th>Bad examples</th>
<th>Note</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Booleans</strong></td>
<td><code>?a=true</code>, <code>?a=false</code></td>
<td><code>?a=1</code>, <code>?a=False</code></td>
<td></td>
</tr>
<tr>
<td><strong>Arrays</strong></td>
<td><code>?id=1&amp;id=2</code></td>
<td><code>?ids=1,2</code>, <code>?ids=1&amp;ids=2</code></td>
<td>Use singular in parameter name</td>
</tr>
</tbody>
</table>
<p>If your API requests are complex and need a lot of query parameters, consider
moving all parameters to a configurable body request JSON object similar to
Elasticsearch queries.</p>
<h4 id="minimize-path-nesting"><a class="header-anchor" href="#minimize-path-nesting" aria-hidden="true">&#xB6;</a> Minimize path nesting</h4>
<p>In data models with nested parent/child resource relationships, paths
may become deeply nested, e.g.:</p>
<pre><code>/stores/:storeId/assortments/:assortmentId/products/:productId
</code></pre>
<p>Limit nesting depth by preferring to locate resources at the root
path. Use nesting to indicate scoped collections. For example, for the
case above where a product belongs to an assortment belongs to a store:</p>
<pre><code>/stores/:storeId
/stores/:storeId/assortments
/assortments/:assortmentId
/assortments/:assortmentId/products
/products/:productId
</code></pre>
<p>In other words, have only one level of parent/child relationship depth in one path.</p>
<h4 id="resource-names"><a class="header-anchor" href="#resource-names" aria-hidden="true">&#xB6;</a> Resource names</h4>
<p>Use the plural version of a resource name unless the resource in question is a
singleton within the system (for example, the overall status of the system might
be <code>/status</code>). This keeps it consistent in the way you refer to particular resources.</p>
<h3 id="respond-structured-and-consistent-errors"><a class="header-anchor" href="#respond-structured-consistent-errors" aria-hidden="true">&#xB6;</a> Respond structured &amp; consistent errors</h3>
<p>Generate consistent, structured response bodies on errors. Include a
human-readable error <code>message</code>.</p>
<pre><code>HTTP/1.1 400 Bad Request
</code></pre>
<pre><code class="lang-json">{
  &quot;<span class="hljs-attr">statusCode</span>&quot;: <span class="hljs-number">400</span>,
  &quot;<span class="hljs-attr">error</span>&quot;: <span class="pl-s">&quot;Bad Request&quot;</span>,
  &quot;<span class="hljs-attr">message</span>&quot;: <span class="pl-s">&quot;child \&quot;weight\&quot; fails because [\&quot;weight\&quot; is required]&quot;</span>,
  &quot;<span class="hljs-attr">validation</span>&quot;: {
      &quot;<span class="hljs-attr">source</span>&quot;: <span class="pl-s">&quot;payload&quot;</span>,
      &quot;<span class="hljs-attr">keys</span>&quot;: [
          <span class="pl-s">&quot;weight&quot;</span>
      ]
  }
}
</code></pre>
<p>Use <a href="https://github.com/hapijs/boom">HapiJS Boom error payload format</a>.</p>
<h3 id="return-appropriate-status-codes"><a class="header-anchor" href="#return-appropriate-status-codes" aria-hidden="true">&#xB6;</a> Return appropriate status codes</h3>
<p>Return appropriate HTTP status codes with each response. Successful
responses should be coded according to this guide:</p>
<ul>
<li><code>200</code>: Request succeeded for a <code>GET</code>, <code>POST</code>, <code>DELETE</code>, or <code>PATCH</code> call that
completed synchronously, or a <code>PUT</code> call that synchronously updated an
existing resource</li>
<li><code>201</code>: Request succeeded for a <code>POST</code>, or <code>PUT</code> call that synchronously
created a new resource. It is also best practice to provide a &apos;Location&#x2019;
header pointing to the newly created resource. This is particularly useful
in the <code>POST</code> context as the new resource will have a different URL than the
original request.</li>
<li><code>202</code>: Request accepted for a <code>POST</code>, <code>PUT</code>, <code>DELETE</code>, or <code>PATCH</code> call that
will be processed asynchronously. E.g. if your task is processed&#xA0;in the background with a worker.</li>
<li><code>206</code>: Request succeeded on <code>GET</code>, but only a partial response
returned: see <a href="#divide-large-responses-across-requests-with-ranges">above on ranges</a></li>
</ul>
<p>Pay attention to the use of authentication and authorization error codes:</p>
<ul>
<li><code>401 Unauthorized</code>: Request failed because user is not authenticated. E.g. token is not valid.</li>
<li><code>403 Forbidden</code>: Request failed because user does not have authorization to access a specific resource. E.g. the given token is not allowed to access the resource.</li>
</ul>
<p>Return suitable codes to provide additional information when there are errors:</p>
<ul>
<li><code>400 Bad Request</code>: Request was incorrectly formed. E.g. invalid json or missing required attributes.</li>
<li><code>422 Unprocessable Entity</code>: Your request was correctly formed, but contained invalid parameters. E.g. endDate is before startDate.</li>
<li><code>429 Too Many Requests</code>: You have been rate-limited, retry later.</li>
<li><code>500 Internal Server Error</code>: Something went wrong on the server, check status site and/or report the issue.</li>
</ul>
<p>Refer to the <a href="https://tools.ietf.org/html/rfc7231#section-6">HTTP response code spec</a>
for guidance on status codes for user error and server error cases.</p>
<h3 id="use-utc-times-formatted-in-iso8601"><a class="header-anchor" href="#use-utc-times-formatted-in-iso8601" aria-hidden="true">&#xB6;</a> Use UTC times formatted in ISO8601</h3>
<p>Accept and return times in UTC only. Render times in ISO8601 format,
e.g.:</p>
<pre><code>&quot;finishedAt&quot;: &quot;2012-01-01T12:00:00Z&quot;
</code></pre>
<p>You may have milliseconds in the timestamp too.</p>
<h3 id="provide-resource-(uu)ids"><a class="header-anchor" href="#provide-resource-uuids" aria-hidden="true">&#xB6;</a> Provide resource (UU)IDs</h3>
<p>Use existing globally unique IDs when possible. E.g. use EAN codes for products
when possible to avoid creating yet another ID. You may use different IDs internally
but public API should only expose one unique ID for a resource. This one ID should be
used in resource objects, url paths etc.</p>
<div class="alert alert-warning" role="alert">
<p>Think carefully before exposing multiple IDs for resources such as EAN and UUID.</p>
</div>
<p>Give each resource an <code>id</code> attribute by default. Use UUIDs unless you
have a very good reason not to. Don&#x2019;t use IDs that won&#x2019;t be globally
unique across instances of the service or other resources in the
service, especially auto-incrementing IDs.</p>
<p>Render UUIDs in downcased <code>8-4-4-4-12</code> format, e.g.:</p>
<pre><code>&quot;id&quot;: &quot;01234567-89ab-cdef-0123-456789abcdef&quot;
</code></pre>
<h2 id="services-should"><a class="header-anchor" href="#services-should" aria-hidden="true">&#xB6;</a> Services should</h2>
<h3 id="separate-concerns"><a class="header-anchor" href="#separate-concerns" aria-hidden="true">&#xB6;</a> Separate concerns</h3>
<p>Keep things simple while designing by separating the concerns between the
different parts of the request and response cycle. Keeping simple rules here
allows for greater focus on larger and harder problems.</p>
<p>Requests and responses will be made to address a particular resource or
collection. Use the path to indicate identity, the body to transfer the
contents and headers to communicate metadata. Query params may be used as a
means to pass header information also in edge cases, but headers are preferred
as they are more flexible and can convey more diverse information.</p>
<h3 id="use-message-queue-architecture-in-heavy-requests"><a class="header-anchor" href="#use-message-queue-architecture-in-heavy-requests" aria-hidden="true">&#xB6;</a> Use message queue architecture in heavy requests</h3>
<p>Separate long running requests to worker processes which live independently
from request-response lifecycle. For example a video resolution scaling would be
a perfect use case for worker architecture. Good rule of thumb is that if
your processing takes &gt;500ms, consider using a background worker.</p>
<p>Benefits:</p>
<ul>
<li>
<p><strong>Always fast HTTP responses (even though the actual processing might take time).</strong> Use a ticketing or similar system to be able to poll progress information.</p>
</li>
<li>
<p><strong>Decouple job processing from web framework.</strong> Allows you to write the worker processing with a different language since the jobs are defined in a generic job queue.</p>
</li>
<li>
<p><strong>Job queues are robust.</strong> They allow retrying, alerts from increasing job queue depth etc.
Worker can be disposed at any time and the job is still persisted in the queue.</p>
</li>
<li>
<p><strong>Scale worker processes independently from HTTP responses.</strong> Background processing might need different specs from the server, e.g. more CPU. HTTP serving is usually more IO-bound.</p>
</li>
</ul>
<p>Read more: <a href="https://devcenter.heroku.com/articles/background-jobs-queueing">https://devcenter.heroku.com/articles/background-jobs-queueing</a></p>
<h3 id="provide-pagination-with-ranges"><a class="header-anchor" href="#provide-pagination-with-ranges" aria-hidden="true">&#xB6;</a> Provide pagination with ranges</h3>
<p>Large responses should be broken across multiple requests using <code>Range</code> headers
to specify when more data is available and how to retrieve it. See the
<a href="https://devcenter.heroku.com/articles/platform-api-reference#ranges">Heroku Platform API discussion of Ranges</a>
for the details of request and response headers, status codes, limits,
ordering, and iteration.</p>
<h3 id="provide-request-ids-for-debugging"><a class="header-anchor" href="#provide-request-ids-for-debugging" aria-hidden="true">&#xB6;</a> Provide request-ids for debugging</h3>
<p>Include a <code>Request-Id</code> header in each API response, populated with a
UUID value. By logging these values on the client, server and any backing
services, it provides a mechanism to trace, diagnose and debug requests.</p>
<h3 id="support-http-cache-headers"><a class="header-anchor" href="#support-http-cache-headers" aria-hidden="true">&#xB6;</a> Support HTTP cache headers</h3>
<p>Recommended way is using an <code>ETag</code> header in all responses, identifying the specific
version of the returned resource. This allows users to cache resources
and use requests with this value in the <code>If-None-Match</code> header to determine
if the cache should be updated.</p>
<p>You can also use different HTTP cache headers for specific use cases but consider
<code>ETag</code> as the default pick.</p>
<h3 id="use-json-ld-with-schema.org-vocabulary"><a class="header-anchor" href="#use-json-ld-with-schemaorg-vocabulary" aria-hidden="true">&#xB6;</a> Use JSON-LD with <a href="http://schema.org">schema.org</a> vocabulary</h3>
<p>Use JSON-LD format with API response data. Link other entities by referencing to an IRI which is expected to return another <a href="http://schema.org">schema.org</a> entity.</p>
<p><a href="http://Schema.org">Schema.org</a> aims to create and maintain open schemas for structured data in the web. Structured data means data that is accompanied by semantics through an ontology. In other words structured data contains information about the data types and hierarchical links and relationships to other entities. JSON-LD is a format specification that extends JSON with linking capabilities. Linked data enables for example rich results in Google search.</p>
<p>Example of JSON-LD with <a href="http://schema.org">schema.org</a> vocabulary:</p>
<pre><code class="lang-json"> {
    &quot;<span class="hljs-attr">@context</span>&quot;: <span class="pl-s">&quot;http://schema.org&quot;</span>,
    &quot;<span class="hljs-attr">@type</span>&quot;: <span class="pl-s">&quot;HardwareStore&quot;</span>,
    &quot;<span class="hljs-attr">branchCode</span>&quot;: <span class="pl-s">&quot;PK035-K-rauta-Lielahti&quot;</span>,
    &quot;<span class="hljs-attr">name</span>&quot;: <span class="pl-s">&quot;K-Rauta Lielahti&quot;</span>,
    &quot;<span class="hljs-attr">telephone</span>&quot;: <span class="pl-s">&quot;010 538 0300&quot;</span>,
    &quot;<span class="hljs-attr">email</span>&quot;: <span class="pl-s">&quot;lielahti@k-rauta.fi&quot;</span>,
    &quot;<span class="hljs-attr">address</span>&quot;: {
      &quot;<span class="hljs-attr">@type</span>&quot;: <span class="pl-s">&quot;PostalAddress&quot;</span>,
      &quot;<span class="hljs-attr">streetAddress</span>&quot;: <span class="pl-s">&quot;Turvesuonkatu 10&quot;</span>,
      &quot;<span class="hljs-attr">addressLocality</span>&quot;: <span class="pl-s">&quot;Tampere&quot;</span>,
      &quot;<span class="hljs-attr">postalCode</span>&quot;: <span class="pl-s">&quot;33400&quot;</span>,
      &quot;<span class="hljs-attr">addressCountry</span>&quot;: <span class="pl-s">&quot;FI&quot;</span>
    },
    &quot;<span class="hljs-attr">hasOfferCatalog</span>&quot;: {
        &quot;<span class="hljs-attr">@type</span>&quot;: <span class="pl-s">&quot;OfferCatalog&quot;</span>,
        &quot;<span class="hljs-attr">name</span>&quot;: <span class="pl-s">&quot;Products&quot;</span>,
        &quot;<span class="hljs-attr">url</span>&quot;: <span class="pl-s">&quot;https://keskoapi.com/api/products/PK035-K-rauta-Lielahti&quot;</span>
    }
  }
</code></pre>
<p>Read more:</p>
<ul>
<li><a href="https://schema.org/">https://schema.org/</a></li>
<li><a href="http://json-ld.org/">http://json-ld.org/</a></li>
</ul>
<h3 id="gzip-and-keep-json-minified-in-all-responses"><a class="header-anchor" href="#gzip-and-keep-json-minified-in-all-responses" aria-hidden="true">&#xB6;</a> GZip and keep JSON minified in all responses</h3>
<p>Extra whitespace adds needless response size to requests, and many
clients for human consumption will automatically &#x201C;prettify&#x201D; JSON
output. It is best to keep JSON responses minified e.g.:</p>
<pre><code class="lang-json">{&quot;<span class="hljs-attr">beta</span>&quot;:<span class="pl-c1">false</span>,&quot;<span class="hljs-attr">email</span>&quot;:<span class="pl-s">&quot;alice@heroku.com&quot;</span>,&quot;<span class="hljs-attr">id</span>&quot;:<span class="pl-s">&quot;01234567-89ab-cdef-0123-456789abcdef&quot;</span>,&quot;<span class="hljs-attr">lastLogin</span>&quot;:<span class="pl-s">&quot;2012-01-01T12:00:00Z&quot;</span>,&quot;<span class="hljs-attr">createdAt</span>&quot;:<span class="pl-s">&quot;2012-01-01T12:00:00Z&quot;</span>,&quot;<span class="hljs-attr">updatedAt</span>&quot;:<span class="pl-s">&quot;2012-01-01T12:00:00Z&quot;</span>}
</code></pre>
<p>Instead of e.g.:</p>
<pre><code class="lang-json">{
  &quot;<span class="hljs-attr">beta</span>&quot;: <span class="pl-c1">false</span>,
  &quot;<span class="hljs-attr">email</span>&quot;: <span class="pl-s">&quot;alice@heroku.com&quot;</span>,
  &quot;<span class="hljs-attr">id</span>&quot;: <span class="pl-s">&quot;01234567-89ab-cdef-0123-456789abcdef&quot;</span>,
  &quot;<span class="hljs-attr">lastLogin</span>&quot;: <span class="pl-s">&quot;2012-01-01T12:00:00Z&quot;</span>,
  &quot;<span class="hljs-attr">createdAt</span>&quot;: <span class="pl-s">&quot;2012-01-01T12:00:00Z&quot;</span>,
  &quot;<span class="hljs-attr">updatedAt</span>&quot;: <span class="pl-s">&quot;2012-01-01T12:00:00Z&quot;</span>
}
</code></pre>
<p>You should also compress the API responses with GZip if client supports it.</p>
<h3 id="provide-full-resources-where-available"><a class="header-anchor" href="#provide-full-resources-where-available" aria-hidden="true">&#xB6;</a> Provide full resources where available</h3>
<p>Provide the full resource representation (i.e. the object with all
attributes) whenever possible in the response. Always provide the full
resource on 200 and 201 responses, including <code>PUT</code>/<code>PATCH</code> and <code>DELETE</code>
requests, e.g.:</p>
<pre><code class="lang-bash">$ curl -X DELETE \
  https://service.com/apps/1f9b/domains/0fd4

HTTP/1.1 200 OK
Content-Type: application/json;charset=utf-8
...
{
  <span class="pl-s">&quot;createdAt&quot;</span>: <span class="pl-s">&quot;2012-01-01T12:00:00Z&quot;</span>,
  <span class="pl-s">&quot;hostname&quot;</span>: <span class="pl-s">&quot;subdomain.example.com&quot;</span>,
  <span class="pl-s">&quot;id&quot;</span>: <span class="pl-s">&quot;01234567-89ab-cdef-0123-456789abcdef&quot;</span>,
  <span class="pl-s">&quot;updatedAt&quot;</span>: <span class="pl-s">&quot;2012-01-01T12:00:00Z&quot;</span>
}
</code></pre>
<p>202 responses will not include the full resource representation,
e.g.:</p>
<pre><code class="lang-bash">$ curl -X DELETE \
  https://service.com/apps/1f9b/dynos/05bd

HTTP/1.1 202 Accepted
Content-Type: application/json;charset=utf-8
...
{}
</code></pre>
<h3 id="provide-standard-timestamps"><a class="header-anchor" href="#provide-standard-timestamps" aria-hidden="true">&#xB6;</a> Provide standard timestamps</h3>
<p>Provide <code>createdAt</code> and <code>updatedAt</code> timestamps for resources by default,
e.g:</p>
<pre><code class="lang-javascript">{
  <span class="pl-c">// ...</span>
  <span class="pl-s">&quot;createdAt&quot;</span>: <span class="pl-s">&quot;2012-01-01T12:00:00Z&quot;</span>,
  <span class="pl-s">&quot;updatedAt&quot;</span>: <span class="pl-s">&quot;2012-01-01T13:00:00Z&quot;</span>,
  <span class="pl-c">// ...</span>
}
</code></pre>
<p>These timestamps may not make sense for some resources, in which case
they can be omitted.</p>
<h3 id="plan-stability-and-versioning"><a class="header-anchor" href="#plan-stability-and-versioning" aria-hidden="true">&#xB6;</a> Plan stability and versioning</h3>
<p>Plan and ideally describe the stability of your API or its various endpoints according to
its maturity and stability, e.g. with prototype/development/production
flags.</p>
<p>See the <a href="https://devcenter.heroku.com/articles/api-compatibility-policy">Heroku API compatibility policy</a>
for a possible stability and change management approach.</p>
<p>Once your API is declared production-ready and stable, do not make
backwards incompatible changes within that API version. If you need to
make backwards-incompatible changes, create a new API with an
incremented version number.</p>
<h3 id="(todo)-use-_link-for-foreign-key-relations"><a class="header-anchor" href="#todo-use-for-foreign-key-relations" aria-hidden="true">&#xB6;</a> (TODO) Use <code>_link</code> for foreign key relations</h3>
<p>Serialize foreign key references with a nested object, e.g.:</p>
<pre><code class="lang-javascript">{
  <span class="pl-s">&quot;name&quot;</span>: <span class="pl-s">&quot;service-production&quot;</span>,
  <span class="pl-s">&quot;owner&quot;</span>: {
    <span class="pl-s">&quot;_link&quot;</span>: <span class="pl-s">&quot;https://keskoapi.com/api/users/01234567-89ab-cdef-0123-456789abcdef&quot;</span>,
    <span class="pl-s">&quot;id&quot;</span>: <span class="pl-s">&quot;01234567-89ab-cdef-0123-456789abcdef&quot;</span>
  },
  <span class="pl-c">// ...</span>
}
</code></pre>
<p>Instead of e.g.:</p>
<pre><code class="lang-javascript">{
  <span class="pl-s">&quot;name&quot;</span>: <span class="pl-s">&quot;service-production&quot;</span>,
  <span class="pl-s">&quot;ownerId&quot;</span>: <span class="pl-s">&quot;01234567-89ab-cdef-0123-456789abcdef&quot;</span>,
  <span class="pl-c">// ...</span>
}
</code></pre>
<p>If needed, this approach makes it possible to inline more information about the
related resource without having to change the structure of the response
or introduce more top-level response fields, e.g.:</p>
<pre><code class="lang-javascript">{
  <span class="pl-s">&quot;name&quot;</span>: <span class="pl-s">&quot;service-production&quot;</span>,
  <span class="pl-s">&quot;owner&quot;</span>: {
    <span class="pl-s">&quot;id&quot;</span>: <span class="pl-s">&quot;5d8201b0...&quot;</span>,
    <span class="pl-s">&quot;name&quot;</span>: <span class="pl-s">&quot;Alice&quot;</span>,
    <span class="pl-s">&quot;email&quot;</span>: <span class="pl-s">&quot;alice@heroku.com&quot;</span>
  },
  <span class="pl-c">// ...</span>
}
</code></pre>
<div class="alert alert-warning" role="alert">
<p>However prefer linking to the original data instead of inlining data.</p>
</div>
<h2 id="service-internal-building-guidelines"><a class="header-anchor" href="#service-internal-building-guidelines" aria-hidden="true">&#xB6;</a> Service internal building guidelines</h2>
<div class="alert alert-info" role="alert">
<p>The purpose of this guide is to focus on the API design details instead
of the whole architecture, but going through the underlying architecture principles
helps to understand the whole picture.</p>
</div>
<p>Most of the backend services are built with <a href="http://martinfowler.com/microservices/">microservice architecture</a>. The architecture
is used to gain certain benefits. It&#x2019;s not a silver bullet
but has been a good fit for the domain.</p>
<p><strong>Good resources</strong></p>
<ul>
<li><a href="https://medium.com/wso2-insight/guidelines-for-designing-microservices-71ee1997776c#.d3wax578u">https://medium.com/wso2-insight/guidelines-for-designing-microservices-71ee1997776c#.d3wax578u</a></li>
<li><a href="https://www.nginx.com/blog/microservices-at-netflix-architectural-best-practices/">https://www.nginx.com/blog/microservices-at-netflix-architectural-best-practices/</a></li>
<li><a href="http://highscalability.com/blog/2014/4/8/microservices-not-a-free-lunch.html">http://highscalability.com/blog/2014/4/8/microservices-not-a-free-lunch.html</a></li>
</ul>
<p>The following rules should apply for the services to benefit of the architecture:</p>
<h3 id="service-has-a-single-responsibility"><a class="header-anchor" href="#service-has-a-single-responsibility" aria-hidden="true">&#xB6;</a> Service has a single responsibility</h3>
<p>Align them with the business capabilities. By focusing to a single responsibility,
technology choices can be picked to suit the domain best. For example you could
model graph heavy data with a graph-database etc.</p>
<p>If you are unsure about the splitting, it might be a better to create a broader
service first, and split later. This way you don&#x2019;t end up with unnecesssary
operational overhead.</p>
<h3 id="services-are-independent"><a class="header-anchor" href="#services-are-independent" aria-hidden="true">&#xB6;</a> Services are independent</h3>
<p>For example product service can be deployed independently from product order status service.
When product order status service is down or has broken, product service should not be
affected by the incident.</p>
<p>Services should also have independent attached resources such as Redis, Postgres etc.</p>
<div class="alert alert-warning" role="alert">
<p>Example smell of bad design: deploying a service requires updating another service
at the same time. Correct versioning fixes this.</p>
</div>
<h3 id="design-for-failures"><a class="header-anchor" href="#design-for-failures" aria-hidden="true">&#xB6;</a> Design for failures</h3>
<p>When accessing data of other microservices, you should use their normal HTTP APIs.
Treat them as you would e.g. when integrating to GitHub API.
And as said before, assume it to be down at any time.</p>
<p>Each microservice should be horizontally scalable to avoid single point of failures.</p>
<h3 id="delegate-common-service-needs-to-an-api-gateway"><a class="header-anchor" href="#delegate-common-service-needs-to-an-api-gateway" aria-hidden="true">&#xB6;</a> Delegate common service needs to an API gateway</h3>
<p>For example:</p>
<ul>
<li><strong>Rate limiting</strong></li>
<li><strong>Monitoring</strong></li>
<li><strong>API user authentication management</strong>
e.g. giving access to the whole API for a 3rd party developer.
<em>Different than API GW &lt;-&gt; Microservice authentication</em></li>
</ul>
<h3 id="services-should-have-multiple-environments"><a class="header-anchor" href="#services-should-have-multiple-environments" aria-hidden="true">&#xB6;</a> Services should have multiple environments</h3>
<p>Environments help in rapid development. This is a good, in practice tested, set of
environments you should have. At <strong>minimum</strong>, have <code>qa</code> and <code>prod</code> environments.</p>
<table>
<thead>
<tr>
<th>Environment</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>dev</code></td>
<td>Experimental. Sharing new features / fixes to other developers or customer. May break at any time, but should be kept as a working environment.</td>
</tr>
<tr>
<td><code>qa</code></td>
<td>Should be as close as <code>prod</code> as possible. All deployments <strong>must</strong> be tested in this environment before deployment to <code>prod</code>.</td>
</tr>
<tr>
<td><code>prod</code></td>
<td>The real deal. Used to serve end users. Response times should ideally be &lt;100ms</td>
</tr>
</tbody>
</table>
<p>All these environments should be as similar to each other as possible, e.g. have
the same external dependencies(Postgres 9.4).</p>

        </div>
      </div>
      <div class="menu toc-menu">
        <li class="menu-item -level-0 -parent">
          <ul class="submenu">
            <li class="menu-item -level-1"><a href="index.html" class="link title -active link-index">Kesko HTTP Service Design</a>
            </li>
            <li class="menu-item -level-1"><a href="#goal-of-the-document" class="link title link-goal-of-the-document">Goal of the document</a>
            </li>
            <li class="menu-item -level-1 -parent"><a href="#services-must" class="link title link-services-must">Services must</a>
              <ul class="submenu">
                <li class="menu-item -level-2"><a href="#provide-certain-mandatory-artifactsactions" class="link title link-provide-certain-mandatory-artifactsactions">Provide certain mandatory artifacts/actions</a>
                </li>
                <li class="menu-item -level-2"><a href="#support-kesko-openid-authentication" class="link title link-support-kesko-openid-authentication">Support Kesko OpenID authentication</a>
                </li>
                <li class="menu-item -level-2"><a href="#require-versioning-headers" class="link title link-require-versioning-headers">Require versioning headers</a>
                </li>
                <li class="menu-item -level-2"><a href="#require-https" class="link title link-require-https">Require HTTPS</a>
                </li>
                <li class="menu-item -level-2"><a href="#use-swagger-2.0-to-describe-apis" class="link title link-use-swagger-2.0-to-describe-apis">Use Swagger 2.0 to describe APIs</a>
                </li>
                <li class="menu-item -level-2"><a href="#provide-human-readable-documentation-via-api-connect" class="link title link-provide-human-readable-documentation-via-api-connect">Provide human-readable documentation via API Connect</a>
                </li>
                <li class="menu-item -level-2"><a href="#accept-serialized-json-in-request-bodies" class="link title link-accept-serialized-json-in-request-bodies">Accept serialized JSON in request bodies</a>
                </li>
                <li class="menu-item -level-2"><a href="#use-consistent-http-methods" class="link title link-use-consistent-http-methods">Use consistent HTTP methods</a>
                </li>
                <li class="menu-item -level-2"><a href="#special-action-endpoints" class="link title link-special-action-endpoints">Special action endpoints</a>
                </li>
                <li class="menu-item -level-2"><a href="#follow-naming-conventions" class="link title link-follow-naming-conventions">Follow naming conventions</a>
                </li>
                <li class="menu-item -level-2"><a href="#respond-structured-and-consistent-errors" class="link title link-respond-structured-and-consistent-errors">Respond structured &amp; consistent errors</a>
                </li>
                <li class="menu-item -level-2"><a href="#return-appropriate-status-codes" class="link title link-return-appropriate-status-codes">Return appropriate status codes</a>
                </li>
                <li class="menu-item -level-2"><a href="#use-utc-times-formatted-in-iso8601" class="link title link-use-utc-times-formatted-in-iso8601">Use UTC times formatted in ISO8601</a>
                </li>
                <li class="menu-item -level-2"><a href="#provide-resource-(uu)ids" class="link title link-provide-resource-(uu)ids">Provide resource (UU)IDs</a>
                </li>
              </ul>
            </li>
            <li class="menu-item -level-1 -parent"><a href="#services-should" class="link title link-services-should">Services should</a>
              <ul class="submenu">
                <li class="menu-item -level-2"><a href="#separate-concerns" class="link title link-separate-concerns">Separate concerns</a>
                </li>
                <li class="menu-item -level-2"><a href="#use-message-queue-architecture-in-heavy-requests" class="link title link-use-message-queue-architecture-in-heavy-requests">Use message queue architecture in heavy requests</a>
                </li>
                <li class="menu-item -level-2"><a href="#provide-pagination-with-ranges" class="link title link-provide-pagination-with-ranges">Provide pagination with ranges</a>
                </li>
                <li class="menu-item -level-2"><a href="#provide-request-ids-for-debugging" class="link title link-provide-request-ids-for-debugging">Provide request-ids for debugging</a>
                </li>
                <li class="menu-item -level-2"><a href="#support-http-cache-headers" class="link title link-support-http-cache-headers">Support HTTP cache headers</a>
                </li>
                <li class="menu-item -level-2"><a href="#use-json-ld-with-schema.org-vocabulary" class="link title link-use-json-ld-with-schema.org-vocabulary">Use JSON-LD with schema.org vocabulary</a>
                </li>
                <li class="menu-item -level-2"><a href="#gzip-and-keep-json-minified-in-all-responses" class="link title link-gzip-and-keep-json-minified-in-all-responses">GZip and keep JSON minified in all responses</a>
                </li>
                <li class="menu-item -level-2"><a href="#provide-full-resources-where-available" class="link title link-provide-full-resources-where-available">Provide full resources where available</a>
                </li>
                <li class="menu-item -level-2"><a href="#provide-standard-timestamps" class="link title link-provide-standard-timestamps">Provide standard timestamps</a>
                </li>
                <li class="menu-item -level-2"><a href="#plan-stability-and-versioning" class="link title link-plan-stability-and-versioning">Plan stability and versioning</a>
                </li>
                <li class="menu-item -level-2"><a href="#(todo)-use-_link-for-foreign-key-relations" class="link title link-(todo)-use-_link-for-foreign-key-relations">(TODO) Use `_link` for foreign key relations</a>
                </li>
              </ul>
            </li>
            <li class="menu-item -level-1 -parent"><a href="#service-internal-building-guidelines" class="link title link-service-internal-building-guidelines">Service internal building guidelines</a>
              <ul class="submenu">
                <li class="menu-item -level-2"><a href="#service-has-a-single-responsibility" class="link title link-service-has-a-single-responsibility">Service has a single responsibility</a>
                </li>
                <li class="menu-item -level-2"><a href="#services-are-independent" class="link title link-services-are-independent">Services are independent</a>
                </li>
                <li class="menu-item -level-2"><a href="#design-for-failures" class="link title link-design-for-failures">Design for failures</a>
                </li>
                <li class="menu-item -level-2"><a href="#delegate-common-service-needs-to-an-api-gateway" class="link title link-delegate-common-service-needs-to-an-api-gateway">Delegate common service needs to an API gateway</a>
                </li>
                <li class="menu-item -level-2"><a href="#services-should-have-multiple-environments" class="link title link-services-should-have-multiple-environments">Services should have multiple environments</a>
                </li>
              </ul>
            </li>
          </ul>
        </li>
      </div>
    </div>
  </body>
</html>